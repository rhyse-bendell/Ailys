name: Build context pack

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pack:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip

      - name: Force UTF-8 on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          chcp 65001
          $env:PYTHONIOENCODING="utf-8"

      - name: Build context pack
        env:
          PYTHONIOENCODING: "utf-8"
        run: python scripts/context_pack.py


      - name: List build outputs (debug)
        run: |
          echo "Repo root:"
          dir
          echo ""
          echo "dist folder (if exists):"
          if (Test-Path dist) { dir dist } else { echo "dist not found" }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aily-context-pack
          path: |
            dist/ailys-context-*.zip
            dist/CODEMAP-*.md
          if-no-files-found: warn

